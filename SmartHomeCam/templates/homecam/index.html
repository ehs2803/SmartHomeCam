{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Cam</title>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="{% static 'css/mainpage/styles.css' %}" rel="stylesheet"/>
</head>
<body>
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
    <div class="container px-5">
        <a class="navbar-brand" href="/">Smart Supervisor</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span
                class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto">
                {% if user %}
                    <li class="nav-item"><a class="nav-link" href="/mypage">mypage</a></li>
                    <li class="nav-item"><a class="nav-link" href="/account/logout">logout</a></li>
                {% else %}
                    <li class="nav-item"><a class="nav-link" href="/account/signup">Sign Up</a></li>
                    <li class="nav-item"><a class="nav-link" href="/account">Log In</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
<header class="masthead text-center text-white">
    {#    <div class="masthead-content">#}
    {#        <a href="basic"><img class="img-fluid rounded-circle"#}
    {#                             src="{% static 'assets/homecam/button_livecam.jpg' %}" alt="..."/></a>#}
    {#    </div>#}
    {#    <br>#}
    {#    <div class="masthead-content">#}
    {#        <img class="img-fluid rounded-circle" src="{% static 'assets/homecam/button_person.jpg' %}" alt="..."/>#}
    {#        <img class="img-fluid rounded-circle" src="{% static 'assets/homecam/button_face.jpg' %}" alt="..."/>#}
    {#        <img class="img-fluid rounded-circle" src="{% static 'assets/homecam/button_fire.jpg' %}" alt="..."/>#}
    {#    </div>#}
    {#    <div class="masthead-content">#}
    {#        <img class="img-fluid rounded-circle" src="{% static 'assets/homecam/button_animal.jpg' %}" alt="..."/>#}
    {#        <img class="img-fluid rounded-circle" src="{% static 'assets/homecam/button_safe.jpg' %}" alt="..."/>#}
    {#    </div>#}
    {#    <div class="bg-circle-1 bg-circle"></div>#}
    {#    <div class="bg-circle-2 bg-circle"></div>#}
    {#    <div class="bg-circle-3 bg-circle"></div>#}
    {#    <div class="bg-circle-4 bg-circle"></div>#}
    <div style="text-align: center">
        <div style="text-align: left; color:black; font-weight:bold; background-color: #ffffff; width: 50%; margin: auto;">
            <p>아래 코드를 복사해 카메라가 있는 디바이스에서 실행시키면 서버와 연결됩니다.</p>
            <p>msg = 'temp1:home1'에서 temp1은 회원가입 시 입력한 username, home1은 홈캠 ID를 의미합니다.</p>
        </div>
    </div>
    <div style="text-align: center">
        <div style="text-align: left; color:black; font-weight:bold; background-color: #ffffff; width: 50%; margin: auto;">

            <p># 필요한 패키지 import</p>
            <p>import cv2 # OpenCV(실시간 이미지 프로세싱) 모듈
            <p>import socket # 소켓 프로그래밍에 필요한 API를 제공하는 모듈
            <p>import pickle # 바이트(bytes) 형식의 데이터 변환 모듈
            <p>import struct # 바이트(bytes) 형식의 데이터 처리 모듈

            <p># 서버 ip 주소 및 port 번호
            <p>ip = '127.0.0.1'
            <p>port = 50002

            <p># 카메라 또는 동영상
            <p>capture = cv2.VideoCapture(0)

            <p># 프레임 크기 지정
            <p>capture.set(cv2.CAP_PROP_FRAME_WIDTH, 640) # 가로
            <p>capture.set(cv2.CAP_PROP_FRAME_HEIGHT, 480) # 세로
            <p>print('cam success')
            <p># 소켓 객체 생성
            <p>client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            <p># 서버와 연결
            <p>client_socket.connect((ip, port))
            <p>print("연결 성공")
            <p># 메시지는 hello로 보낸다.
            <p>msg = 'temp1:home1'
            <p># 메시지를 바이너리(byte)형식으로 변환한다.
            <p>data = msg.encode();
            <p># 메시지 길이를 구한다.
            <p>length = len(data);
            <p># server로 리틀 엔디언 형식으로 데이터 길이를 전송한다.
            <p>client_socket.sendall(length.to_bytes(4, byteorder="little"));
            <p># 데이터를 전송한다.
            <p>client_socket.sendall(data);

            <p># 메시지 수신
            <p>try:
            <p>while True:
            <p># 프레임 읽기
            <p>retval, frame = capture.read()

            <p># imencode : 이미지(프레임) 인코딩
            <p># 1) 출력 파일 확장자
            <p># 2) 인코딩할 이미지
            <p># 3) 인코드 파라미터
            <p># - jpg의 경우 cv2.IMWRITE_JPEG_QUALITY를 이용하여 이미지의 품질(0 ~ 100)을 설정
            <p># - png의 경우 cv2.IMWRITE_PNG_COMPRESSION을 이용하여 이미지의 압축률(0 ~ 9)을 설정
            <p># [return]
            <p># 1) 인코딩 결과(True / False)
            <p># 2) 인코딩된 이미지
            <p>retval, frame = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 50])

            <p># dumps : 데이터를 직렬화
            <p># - 직렬화(serialization) : 효율적으로 저장하거나 스트림으로 전송할 때 데이터를 줄로 세워 저장하는 것
            <p>frame = pickle.dumps(frame)

            <p>print("전송 프레임 크기 : {} bytes".format(len(frame)))

            <p># sendall : 데이터(프레임) 전송
            <p># - 요청한 데이터의 모든 버퍼 내용을 전송
            <p># - 내부적으로 모두 전송할 때까지 send 호출
            <p># struct.pack : 바이트 객체로 변환
            <p># - > : 빅 엔디안(big endian)
            <p># - 엔디안(endian) : 컴퓨터의 메모리와 같은 1차원의 공간에 여러 개의 연속된 대상을 배열하는 방법
            <p># - 빅 엔디안(big endian) : 최상위 바이트부터 차례대로 저장
            <p># - L : 부호없는 긴 정수(unsigned long) 4 bytes
            <p>try:
            <p>client_socket.sendall(struct.pack(">L", len(frame)) + frame)
            <p>except:
            <p>break
            <p>data = client_socket.recv(4);
            <p>print(data)
            <p>except KeyboardInterrupt:
            <p># 메모리를 해제
            <p>print('intercept')
            <p>client_socket.sendall("disconnect".encode())
            <p>client_socket.close()
            <p>capture.release()


        </div>
    </div>


</header>
<!-- Footer-->
<footer class="py-5 bg-black">
    <div class="container px-5"><p class="m-0 text-center text-white small">Copyright &copy; SmartHomeCam 2022</p></div>
</footer>
</body>
</html>